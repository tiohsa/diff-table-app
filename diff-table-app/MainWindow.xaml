<Window x:Class="diff_table_app.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:diff_table_app.ViewModels"
        xmlns:models="clr-namespace:diff_table_app.Models"
        xmlns:sys="clr-namespace:System;assembly=System.Runtime"
        mc:Ignorable="d"
        Title="DB Diff Tool" Height="800" Width="1200"
        Background="{StaticResource Slate50}">
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <ObjectDataProvider x:Key="DatabaseTypes" MethodName="GetValues" ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:DatabaseType"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <Style TargetType="DataGridRow">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Status}" Value="Added">
                    <Setter Property="Background" Value="{StaticResource Emerald100}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Status}" Value="Deleted">
                    <Setter Property="Background" Value="{StaticResource Red100}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Status}" Value="Modified">
                    <Setter Property="Background" Value="{StaticResource Amber100}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Main Content Area -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="450" MinWidth="350"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Left Panel: Settings -->
                <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Padding="0,0,10,0">
                    <StackPanel>
                        <!-- Presets Section -->
                        <Border BorderBrush="{StaticResource Slate300}" BorderThickness="1" CornerRadius="6" Padding="15" Margin="0,0,0,15" Background="White">
                            <StackPanel>
                                <TextBlock Text="Preset Management" FontWeight="Bold" Foreground="{StaticResource Slate700}" Margin="0,0,0,10"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox ItemsSource="{Binding Presets}" SelectedItem="{Binding SelectedPreset}" DisplayMemberPath="Name" Margin="0,0,5,0" />
                                    <Button Grid.Column="1" Content="Load" Command="{Binding ApplyPresetCommand}" Margin="0,0,5,0" Width="60"/>
                                    <Button Grid.Column="2" Content="Delete" Command="{Binding DeletePresetCommand}" Background="{StaticResource Red500}" Width="60"/>
                                </Grid>

                                <Grid Margin="0,10,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Text="{Binding NewPresetName}" ToolTip="New Preset Name" Margin="0,0,5,0"/>
                                    <Button Grid.Column="1" Content="Save" Command="{Binding SavePresetCommand}" Width="60"/>
                                </Grid>
                            </StackPanel>
                        </Border>

                        <!-- Connection Settings -->
                        <Expander Header="Connection Settings" IsExpanded="True" Margin="0,0,0,15">
                            <Grid Margin="0,5,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Source -->
                                <GroupBox Header="Source DB" Margin="0,0,5,0">
                                    <StackPanel DataContext="{Binding SourceConnection}">
                                        <ComboBox ItemsSource="{Binding Source={StaticResource DatabaseTypes}}"
                                                  SelectedItem="{Binding SelectedType, Mode=TwoWay}"
                                                  Margin="0,5"/>

                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="Host:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Host}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="Port:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Port}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="User:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding User}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="Pass:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Password}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="DB/SID:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Database}"/>
                                        </DockPanel>
                                        <Button Content="Test Connection" Command="{Binding TestConnectionCommand}" Margin="0,8,0,0" Background="{StaticResource Slate500}"/>
                                    </StackPanel>
                                </GroupBox>

                                <!-- Target -->
                                <GroupBox Header="Target DB" Grid.Column="1" Margin="5,0,0,0">
                                    <StackPanel DataContext="{Binding TargetConnection}">
                                        <ComboBox ItemsSource="{Binding Source={StaticResource DatabaseTypes}}"
                                                  SelectedItem="{Binding SelectedType, Mode=TwoWay}"
                                                  Margin="0,5"/>

                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="Host:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Host}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="Port:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Port}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="User:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding User}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="Pass:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Password}"/>
                                        </DockPanel>
                                        <DockPanel Margin="0,2">
                                            <TextBlock Text="DB/SID:" Width="50" Foreground="{StaticResource Slate600}"/>
                                            <TextBox Text="{Binding Database}"/>
                                        </DockPanel>
                                        <Button Content="Test Connection" Command="{Binding TestConnectionCommand}" Margin="0,8,0,0" Background="{StaticResource Slate500}"/>
                                    </StackPanel>
                                </GroupBox>
                            </Grid>
                        </Expander>

                        <!-- Mode Selection -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,15" HorizontalAlignment="Center">
                            <RadioButton Content="Table Compare Mode" IsChecked="{Binding IsTableMode}" Margin="0,0,15,0" VerticalContentAlignment="Center"/>
                            <RadioButton Content="SQL Compare Mode" IsChecked="{Binding IsSqlMode}" VerticalContentAlignment="Center"/>
                        </StackPanel>

                        <!-- Settings Area -->
                        <Border BorderBrush="{StaticResource Slate300}" BorderThickness="1" CornerRadius="6" Padding="15" Margin="0,0,0,15" Background="White">
                            <Grid>
                                <!-- Table Mode UI -->
                                <Grid Visibility="{Binding IsTableMode, Converter={StaticResource BoolToVis}}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <Button Grid.Row="0" Grid.ColumnSpan="2" Content="Load Schemas" Command="{Binding LoadSchemasCommand}" HorizontalAlignment="Left" Width="140" Margin="0,0,0,15" Background="{StaticResource Slate600}"/>

                                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,5,10">
                                        <TextBlock Text="Source Schema/Table" Foreground="{StaticResource Slate600}" Margin="0,0,0,2"/>
                                        <TextBox Text="{Binding SourceSchemaFilter, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,2" ToolTip="Filter Schema"/>
                                        <ComboBox ItemsSource="{Binding SourceSchemas}" SelectedItem="{Binding SelectedSourceSchema}" Margin="0,0,0,5"/>
                                        <TextBox Text="{Binding SourceTableFilter, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,2" ToolTip="Filter Table"/>
                                        <ComboBox ItemsSource="{Binding SourceTables}" SelectedItem="{Binding SelectedSourceTable}"/>
                                    </StackPanel>

                                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="5,0,0,10">
                                        <TextBlock Text="Target Schema/Table" Foreground="{StaticResource Slate600}" Margin="0,0,0,2"/>
                                        <TextBox Text="{Binding TargetSchemaFilter, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,2" ToolTip="Filter Schema"/>
                                        <ComboBox ItemsSource="{Binding TargetSchemas}" SelectedItem="{Binding SelectedTargetSchema}" Margin="0,0,0,5"/>
                                        <TextBox Text="{Binding TargetTableFilter, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,2" ToolTip="Filter Table"/>
                                        <ComboBox ItemsSource="{Binding TargetTables}" SelectedItem="{Binding SelectedTargetTable}"/>
                                    </StackPanel>

                                    <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Margin="0,5,0,0">
                                        <TextBlock Text="Keys (comma separated):" Foreground="{StaticResource Slate600}" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding KeysInput}"/>
                                        <TextBlock Text="Ignore Columns (comma separated):" Foreground="{StaticResource Slate600}" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding IgnoreColumnsInput}"/>
                                        <TextBlock Text="Column Mapping (select pairs):" Foreground="{StaticResource Slate600}" Margin="0,5,0,2"/>
                                        <StackPanel>
                                            <ItemsControl ItemsSource="{Binding ColumnMappings}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                            <ComboBox Width="180"
                                                                      ItemsSource="{Binding DataContext.SourceColumns, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                      SelectedItem="{Binding SourceColumn, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                      Margin="0,0,5,0"/>
                                                            <TextBlock Text="â†’" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="{StaticResource Slate600}"/>
                                                            <ComboBox Width="180"
                                                                      ItemsSource="{Binding DataContext.TargetColumns, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                      SelectedItem="{Binding TargetColumn, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                      Margin="0,0,5,0"/>
                                                            <Button Content="Remove"
                                                                    Command="{Binding DataContext.RemoveMappingCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                    CommandParameter="{Binding}"
                                                                    Background="{StaticResource Slate200}"
                                                                    Padding="6,2"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                                <Button Content="Add Mapping"
                                                        Command="{Binding AddMappingCommand}"
                                                        Background="{StaticResource Slate500}"
                                                        Width="120"/>
                                                <TextBlock Text="Load schemas/tables to populate column lists." Margin="10,4,0,0" Foreground="{StaticResource Slate500}"/>
                                            </StackPanel>
                                        </StackPanel>
                                        <TextBlock Text="WHERE Clause (optional):" Foreground="{StaticResource Slate600}" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding WhereClause}"/>
                                    </StackPanel>
                                </Grid>

                                <!-- SQL Mode UI -->
                                <Grid Visibility="{Binding IsSqlMode, Converter={StaticResource BoolToVis}}">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <GroupBox Header="Source SQL" Grid.Row="0" Grid.Column="0" Margin="0,0,5,0" Height="150">
                                        <TextBox Text="{Binding SourceSql}" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" BorderThickness="0"/>
                                    </GroupBox>
                                    <GroupBox Header="Target SQL" Grid.Row="0" Grid.Column="1" Margin="5,0,0,0" Height="150">
                                        <TextBox Text="{Binding TargetSql}" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" BorderThickness="0"/>
                                    </GroupBox>

                                    <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Margin="0,10,0,0">
                                        <TextBlock Text="Keys (comma separated):" Foreground="{StaticResource Slate600}" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding KeysInput}"/>
                                        <TextBlock Text="Target Table Name for SQL Generation:" Foreground="{StaticResource Slate600}" Margin="0,5,0,2"/>
                                        <TextBox Text="{Binding TargetTableNameForSql}"/>
                                    </StackPanel>
                                </Grid>
                            </Grid>
                        </Border>

                        <!-- Actions Buttons -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10" HorizontalAlignment="Right">
                            <CheckBox Content="Show Diff Only" IsChecked="{Binding ShowDiffOnly}" VerticalAlignment="Center" Margin="0,0,15,0"/>
                            <Button Content="COMPARE" Command="{Binding CompareCommand}" Width="120" FontWeight="Bold" Margin="0,0,10,0"/>
                            <Button Content="Generate SQL" Command="{Binding GenerateSqlCommand}" Width="120" Background="{StaticResource Emerald500}"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>

                <!-- Splitter -->
                <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch" Background="{StaticResource Slate200}" ShowsPreview="True"/>

                <!-- Right Panel: DataGrid -->
                <Grid Grid.Column="2" Margin="10,0,0,0">
                    <DataGrid ItemsSource="{Binding ResultView}" AutoGenerateColumns="True" IsReadOnly="True"
                              EnableRowVirtualization="True" EnableColumnVirtualization="True"
                              GridLinesVisibility="All">
                    </DataGrid>
                </Grid>
            </Grid>

            <!-- StatusBar -->
            <StatusBar Grid.Row="1" Background="{StaticResource Slate100}" BorderBrush="{StaticResource Slate200}" BorderThickness="0,1,0,0" Padding="5,0">
                <StatusBarItem>
                    <TextBlock Text="{Binding StatusMessage}" Foreground="{StaticResource Slate600}" FontSize="12"/>
                </StatusBarItem>
                <StatusBarItem HorizontalAlignment="Right">
                    <ProgressBar IsIndeterminate="True" Width="100" Height="12" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}"/>
                </StatusBarItem>
            </StatusBar>
        </Grid>

        <!-- Busy Overlay -->
        <Grid Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" d:Visibility="Visible">
            <Border Background="White" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="20" CornerRadius="8">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="5" Opacity="0.3"/>
                </Border.Effect>
                <StackPanel>
                    <ProgressBar IsIndeterminate="True" Width="150" Height="20" Margin="0,0,0,10"/>
                    <TextBlock Text="Processing..." HorizontalAlignment="Center" Foreground="{StaticResource Slate700}" FontWeight="Bold"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>
